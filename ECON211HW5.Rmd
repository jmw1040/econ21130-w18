---
title: "Homework on unobserved hetereogeneity"
output:
  html_document:
    toc: yes
    toc_depth: 3
    toc_float:
      collapsed: no
      smooth_scroll: no
  pdf_document:
    toc: yes
    toc_depth: '3'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(kableExtra)
library(ggplot2)
library(texreg)
library(readstata13)
library(sandwich)
options(knitr.table.format = "html") 
library(data.table)
library(plm)
library(lmtest)
library(rlist)
```

# A Simple Model 
### Question 1 
### Question 2
#Simulating data 

```{r}
p = list(rho=0.9,a = 3, gamma =1.5)
p$n = 1000
data = data.table(B = 0, W = exp(rnorm(p$n) -3))

# solve for lambda
data[, Lb := ((p$rho*W - B)/(p$a))^(1/(1+p$gamma))]
data[, Lb := pmin(pmax(Lb,0),1)]

data[, D  := rexp(p$n, rate = Lb)]

ggplot(data,aes(x=W,y=Lb)) + geom_line() + theme_bw()
```


# Estimating 
### Question Three 

```{r}
lam = function(a, gamma, rho=0.9, W, B=0) { ( (rho * W - B) / a)^(1/(1+gamma))   }

a = seq(2.5, 3.5, .001)
g = seq(1, 2, .001)
grid = expand.grid(a,g)


lik.homo = function(W, D, grid) {
  n = length(W)
  a = grid["Var1"]  
  gamma= grid["Var2"] 
  lambda = lam(a, gamma, p$rho, W)
  likelihood = (log(lambda) * n - (lambda*sum(D))) 
  index = which.max(likelihood)
  return(grid[index,])
  
}
lik.homo(data$W,data$D,grid)


```

### Question Four 
# Random Effect 
### Question 5 
```{r}
p = list(rho=0.9,a = c(1,3,5), gamma =1.5, pk=c(0.2,0.5,0.3))

p$n = 1000
data = data.table(B = 0, W = exp(rnorm(p$n) -2))

# draw the latent type
data[, k := sample.int(3,.N,prob = p$pk,replace=T)]

# solve for lambda
data[, Lb := ((p$rho*W - B)/(p$a[k]))^(1/(1+p$gamma))]
data[, Lb := pmin(pmax(Lb,0),1)] # bound it between 0 and 1

data[, D := rexp(p$n, rate = Lb)]
```
```{r}
lik.homo.i = function(W,D, pk, a, gamma)
{
  lambda = lam(a, gamma, .9, W, 0)
  return(sum(pk * lambda * exp(-lambda * D)))
}
lik.homo.k = function(W,D, pk, a, gamma) { 
  i_s = mapply(lik.homo.i, W, D, MoreArgs = list(pk = pk, a = a, gamma = gamma))
  return(sum(log(i_s)))
}

lik.homo.k(data$W,data$D, p$pk, p$a, p$gamma)

g = seq(1, 2, .1)
a1 = seq(.5, 1.5, .1)
a2 = seq(2.5, 3.5, .1)
a3 = seq(4.5, 6.5, .1)
p1 = seq(0, 1, .1)
p2 = seq(0, 1, .1)
grid = expand.grid(g, a1, a2, a3, p1, p2)

maxlik = function(grid, W, D){
  p1 = grid["Var5"]
  p2 = grid["Var6"]
  g = grid["Var1"]
  a1 = grid["Var2"]
  a2 = grid["Var3"]
  a3 = grid["Var4"]
  p3 = 1 - p1 - p2 
  return(lik.homo.k(W, D, cbind(p1,p2,p3), cbind(a1, a2,a3), g))
  
  }

maxlik(head(grid), data$W, data$D )

  
  
```


### Question 6 
### Question 7  
# Fixed Effect 
### Question 8 
### Question 9 


